# Go AST Inspector - 要件定義書

## プロジェクト概要

### 目的
Go言語のソースコードから抽象構文木(AST: Abstract Syntax Tree)を取得し、開発者が直感的に理解できる形式で可視化するツールを提供する。

### 背景・コンテキスト
- Go言語の学習やデバッグ時に、コードがどのようにパースされるかを理解することは重要
- 既存のASTツールは開発環境のセットアップが必要であり、手軽に利用できない
- ブラウザ上で完結するスタンドアローンなツールにより、環境構築なしで即座に利用可能にする

### スコープ
- **対象範囲**: Go言語のソースコードのAST解析と可視化
- **提供形態**: 単一HTMLファイルとして配布可能なスタンドアローンツール
- **対象ユーザー**: Go言語実務開発者（主ターゲット）、学習者、コンパイラ・言語処理系に興味がある技術者

---

## 機能要件

### FR-001: スタンドアローン動作
**優先度**: 必須  
**説明**: ブラウザ上で完全に動作し、外部サーバーとの通信を一切必要としない  
**詳細**:
- 単一のHTMLファイルとして配布可能
- すべてのロジック（AST解析、UI制御）をクライアントサイドで実行
- インターネット接続不要で動作

**根拠**: 
- セキュリティ上の理由でソースコードを外部送信できない環境でも利用可能
- 環境構築の手間を排除し、即座に利用開始できる

**検証基準**:
- [ ] HTMLファイルをローカルで開いた状態で全機能が動作する
- [ ] ネットワークトラフィックが一切発生しない（DevToolsで確認）
- [ ] 外部CDNやリソースへの依存がない

**依存関係**: なし

---

### FR-002: Go言語ソースコードのAST解析
**優先度**: 必須  
**説明**: ユーザーが入力したGo言語のソースコードを解析し、ASTを生成する  
**詳細**:
- Go言語の標準文法に準拠したパーサーを使用
- 構文エラーがある場合は適切なエラーメッセージを表示
- 部分的なコード（式、文、関数単位）も解析可能

**根拠**: 
- ASTの理解には正確な解析結果が不可欠
- 学習目的では小さなコード片の解析も重要

**検証基準**:
- [ ] 有効なGo言語コードを正しくASTに変換できる
- [ ] 構文エラー時に行番号・列番号を含むエラーメッセージを表示
- [ ] 関数定義、型宣言、式など主要な構文要素を解析できる

**依存関係**: なし

---

### FR-003: AST木構造の表示
**優先度**: 必須  
**説明**: 解析されたASTを階層的な木構造として視覚的に表示する  
**詳細**:
- ノードの種類（識別子、リテラル、演算子など）を明示
- 親子関係が視覚的に理解できる表示形式
- ノード選択時にそのノードの詳細情報を表示

**根拠**: 
- ASTの階層構造を理解することがツールの主目的
- 視覚的表現により学習効果が向上

**検証基準**:
- [ ] ASTの全ノードが木構造として表示される
- [ ] ノードタイプ（例: *ast.FuncDecl, *ast.Ident）が表示される
- [ ] 親子関係が明確に識別できる

**依存関係**: FR-002

---

### FR-004: ノードの展開・折りたたみ機能
**優先度**: 必須  
**説明**: 木構造の各ノード（枝）を個別に展開・折りたたみできる  
**詳細**:
- クリック操作で展開/折りたたみを切り替え
- デフォルトの展開レベルを設定可能（例: 2階層まで展開）
- すべて展開/すべて折りたたみ機能を提供
- **キーボードナビゲーション**:
  - 上下矢印キー: 前/次の可視ノードへ移動
  - 右矢印キー: 折りたたまれたノードを展開、または展開済みの場合は最初の子へ移動
  - 左矢印キー: 展開されたノードを折りたたみ、または折りたたみ済みの場合は親へ移動
  - Home / Cmd+上矢印: 最初のノード（ルート）へ移動
  - End / Cmd+下矢印: 最後の可視ノードへ移動
  - アスタリスク (*): 現在のノードとその全子孫を展開
- **フォーカスインジケータ**:
  - ツリーにキーボードフォーカスがある場合は青いアウトラインを表示
  - 選択されたノードは薄い青の背景を表示（ツリーからフォーカスが外れても維持）
- **キーボードショートカットヘルプ**:
  - ASTツリーヘッダーにヘルプボタン（?）を設置し、利用可能なキーボードショートカットを表示
  - ヘルプダイアログ/ツールチップにすべてのキーボードナビゲーションショートカットを表示
  - 外部クリックまたはEscapeキーでヘルプを閉じる

**根拠**: 
- 大きなASTを扱う際に、必要な部分のみに集中できる
- ユーザビリティの向上
- キーボードナビゲーションにより、マウスを使わずに効率的なツリー探索が可能

**検証基準**:
- [ ] 各ノードをクリックして展開/折りたたみできる
- [ ] 展開状態が視覚的に識別できる（例: 矢印アイコン）
- [ ] 全展開/全折りたたみボタンが機能する
- [ ] 矢印キーで可視ノード間を移動できる
- [ ] Home/Endキー（またはMacではCmd+矢印）で最初/最後のノードへジャンプできる
- [ ] キーボード操作時にフォーカスインジケータが表示される
- [ ] ツリーからフォーカスが外れても選択ノードのハイライトが維持される
- [ ] ヘルプボタンでキーボードショートカット情報が表示される
- [ ] 外部クリックまたはEscapeキーでヘルプを閉じることができる

**依存関係**: FR-003

---

### FR-005: ソースコードとASTツリーの双方向連動表示
**優先度**: 必須  
**説明**: ソースコードとASTツリーの双方向連動により、両者の対応関係を視覚的に理解できるようにする  
**詳細**:
- **ソースコード→ASTツリー連動**:
  - ソースコード上でクリック・カーソル移動すると、対応するASTノードをツリービューでハイライト表示
  - 該当ノードが折りたたまれている場合は、そこまでの枝を自動展開
  - 該当ノードまで自動スクロール
- **ASTツリー→ソースコード連動**:
  - ASTツリー上でノードを選択すると、対応するソースコード範囲をハイライト表示
  - ハイライト範囲は背景色の変更により明示
  - 該当箇所まで自動スクロール（推奨）
- ハイライト表示の同期と解除

**根拠**: 
- ソースコードとASTの対応関係を直感的に理解できる
- 双方向の連動により、どちらの視点からも探索可能
- 学習効果の向上
- ツールチップよりもツリー上での確認が視認性が高い

**検証基準**:
- [ ] ソースコード上でクリック・カーソル移動すると対応ASTノードがハイライトされる
- [ ] ハイライト対象ノードが折りたたまれている場合、自動的に展開される
- [ ] ASTツリー上でノードを選択すると対応ソースコード範囲がハイライトされる
- [ ] ソースコードのハイライト範囲が視覚的に明確
- [ ] 選択解除時にハイライトが適切に消える

**依存関係**: FR-002, FR-003, FR-004

---

### FR-006: ソースコード入力機能
**優先度**: 必須  
**説明**: ユーザーがGo言語のソースコードを入力できるテキストエリアを提供  
**詳細**:
- 複数行のコード入力に対応
- シンタックスハイライト表示（推奨）
- デフォルトでHello Worldサンプルコードが入力されている

**根拠**: 
- ユーザーが任意のコードを解析できることが必要
- 初回利用時にすぐに動作を確認できる

**検証基準**:
- [ ] 複数行のコードを入力できる
- [ ] 入力後に解析ボタンまたは自動解析でASTが更新される
- [ ] 日本語コメントを含むコードも正しく扱える
- [ ] ページロード時にHello Worldコードが入力されている

**依存関係**: なし

---

## 非機能要件

### NFR-001: パフォーマンス - レスポンス時間
**優先度**: 必須  
**説明**: 小〜中規模のコード（1000行以下）のAST解析を3秒以内に完了する  
**測定方法**: 解析開始から結果表示までの時間を測定  
**根拠**: ユーザー体験の維持

**検証基準**:
- [ ] 100行のコードを1秒以内に解析・表示
- [ ] 1000行のコードを3秒以内に解析・表示

---

### NFR-002: ブラウザ互換性
**優先度**: 必須  
**説明**: モダンブラウザの最新2バージョンで動作する  
**対象ブラウザ**:
- Google Chrome（最新2バージョン）
- Mozilla Firefox（最新2バージョン）
- Safari（最新2バージョン）
- Microsoft Edge（最新2バージョン）

**根拠**: 
- 幅広いユーザーに提供するため
- モダンブラウザのAPI（ES6+）を活用するため

**検証基準**:
- [ ] 上記ブラウザで全機能が正常動作する
- [ ] レイアウト崩れがない
- [ ] JavaScriptエラーが発生しない

---

### NFR-003: ユーザビリティ - UI/UX
**優先度**: 必須  
**説明**: 実務開発者が直感的に操作できるUI  
**詳細**:
- クリーンで見やすいレイアウト
- 操作方法が自明なUI設計
- 簡潔な説明文・ツールチップの提供

**根拠**: 
- 実務開発者の作業効率を重視し、ツール自体の学習コストを最小化

**検証基準**:
- [ ] 初回利用時に主要機能を5分以内に理解できる
- [ ] エラーメッセージが分かりやすい
- [ ] デスクトップブラウザでの利用に最適化されている

---

### NFR-004: 保守性 - コード品質
**優先度**: 推奨  
**説明**: 将来的な機能追加・バグ修正が容易なコード構造  
**詳細**:
- モジュール化された構造
- 適切なコメント・ドキュメント
- テストコードの整備（推奨）

**根拠**: 
- オープンソースプロジェクトとして継続的な改善を可能にする

**検証基準**:
- [ ] 主要モジュールが独立している
- [ ] 重要な関数にコメントが記載されている
- [ ] README.mdに使い方とアーキテクチャが記載されている

---

### NFR-005: セキュリティ - データ保護
**優先度**: 必須  
**説明**: ユーザーの入力したコードが外部に送信されず、保存もされない  
**詳細**:
- すべての処理をクライアントサイドで完結
- ローカルストレージへの保存は一切行わない
- 入力されたコードはページリロード時に破棄される

**根拠**: 
- 企業の機密コードを扱う可能性があるため
- セキュリティリスクを最小化する

**検証基準**:
- [ ] ネットワークリクエストが一切発生しない
- [ ] ローカルストレージへの書き込みが一切行われない
- [ ] ページリロード時にコードがクリアされる

---

### NFR-006: 可用性 - オフライン動作
**優先度**: 必須  
**説明**: インターネット接続がない環境でも完全に動作する  
**詳細**:
- Service Workerの利用（推奨）
- すべてのリソースをHTMLファイルに埋め込み

**根拠**: 
- スタンドアローン動作の要件を満たすため

**検証基準**:
- [ ] オフライン環境で全機能が動作する
- [ ] 外部リソース依存がない

---

## 制約条件

### TC-001: 技術スタック
- **フロントエンド**: HTML5, CSS3, TypeScript
- **UIフレームワーク**: Svelte 5.x
- **Go ASTパーサー**: WebAssembly版のGoパーサー
- **ビルドツール**: Vite（単一HTMLファイル生成）

### TC-002: 配布形式
- 単一のHTMLファイルとして配布
- ファイルサイズ: 5MB以下（推奨）

### TC-003: ライセンス
- オープンソース（MITライセンス推奨）
- 使用する外部ライブラリもオープンソースライセンスであること

### TC-004: 開発環境
- Go言語開発環境（AST解析ロジックのテスト用）
- モダンブラウザ（開発・テスト用）

---

## ステークホルダー定義

### 利用者（エンドユーザー）
- **Go言語開発者**: コードの構造理解、デバッグ支援
- **Go言語学習者**: 言語仕様・パーサーの学習
- **コンパイラ/言語処理系研究者**: ASTの構造理解

**期待値**:
- 手軽に利用開始できる（環境構築不要）
- 正確なAST情報の取得
- 直感的で分かりやすいUI

### 開発者
- **プロジェクト開発者**: このツールの実装・保守担当者

**期待値**:
- 保守しやすいコード構造
- 明確な技術仕様
- テスト可能な設計

### 運用者
- **なし**: スタンドアローンツールのため、特定の運用者は存在しない

---

## 要件間の依存関係

```
FR-002 (AST解析)
  ├── FR-003 (木構造表示) [MVP必須]
  │     ├── FR-004 (展開・折りたたみ) [MVP必須]
  │     └── FR-005 (ホバー表示) [MVP必須]

FR-006 (入力機能) ──→ FR-002 (AST解析)

FR-001 (スタンドアローン動作) ──→ すべての機能要件に影響
```

**MVP（最小機能プロダクト）スコープ**:
- FR-001, FR-002, FR-003, FR-004, FR-005, FR-006 すべて必須
- ツリー表示と連動ハイライト表示の実装は最優先

---

## 技術選定決定事項

以下の技術選定について決定されました:

### 技術スタック
1. **GoパーサーのJavaScript実装**
   - **決定**: WebAssembly版のGoパーサーを使用

2. **UIフレームワーク**
   - **決定**: Svelte 5.xを使用

3. **ビルドプロセス**
   - **決定**: Viteを使用して単一HTMLファイルを生成

### 機能仕様
4. **サンプルコードのプリセット**
   - **決定**: Hello Worldのみ、デフォルトで入力欄に表示

5. **AST表示形式**
   - **決定**: ツリービュー形式のみをサポート

6. **エクスポート機能**
   - **決定**: 実装しない

7. **ローカルストレージ利用**
   - **決定**: 入力されたコードは一切保存しない

### プロジェクト管理
8. **リリース計画**
   - **MVP範囲**: FR-001〜FR-006すべて必須
   - **最優先実装**: ツリー表示と連動ハイライト表示

9. **対象ユーザーの優先度**
   - **主ターゲット**: Go言語実務開発者

---

## 次のステップ

要件定義が完了しました。次のフェーズとして、以下のコマンド実行を推奨します:

```
/prj-define-design
```

このコマンドにより、本要件定義書をもとに技術設計書が作成され、具体的なアーキテクチャ・モジュール構成・データフロー等が明確化されます。

---

**文書バージョン**: 1.5  
**作成日**: 2025-11-23  
**最終更新日**: 2025-11-30  
**更新履歴**:
- v1.5: FR-004にキーボードショートカットヘルプ表示機能を追加
- v1.4: FR-004にキーボードナビゲーション機能を追加（矢印キー、Home/End、アスタリスクによるサブツリー展開）
- v1.3: FR-005を双方向連動表示に拡張（ソースコードハイライト機能追加）
- v1.2: UIフレームワークをSvelte 5.xに変更、TypeScriptを明記
- v1.1: 技術選定決定事項の反映、エクスポート機能の削除、対象ユーザーの明確化
- v1.0: 初版作成
